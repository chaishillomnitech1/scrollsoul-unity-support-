name: PR Validation

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]

permissions:
  contents: read
  pull-requests: write

jobs:
  pr-validation:
    name: ğŸ¤ Validate Pull Request
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: ğŸ·ï¸ Check PR title
        run: |
          PR_TITLE="${{ github.event.pull_request.title }}"
          echo "Checking PR title: $PR_TITLE"
          
          # Check if title follows conventional format
          if echo "$PR_TITLE" | grep -qE "^(feat|fix|docs|refactor|test|chore|style|perf|ci):"; then
            echo "âœ… PR title follows conventional format"
          else
            echo "âš ï¸ Consider using conventional commit format: type: description"
            echo "   Examples: feat: add new feature, fix: resolve bug, docs: update readme"
          fi
      
      - name: ğŸ“ Check PR description
        run: |
          PR_BODY="${{ github.event.pull_request.body }}"
          
          if [ -z "$PR_BODY" ]; then
            echo "âš ï¸ PR description is empty. Please add a description."
          else
            echo "âœ… PR has a description"
            
            # Check for alignment with principles
            if echo "$PR_BODY" | grep -qE "LOVE|UNITY|TRUTH|ETERNAL"; then
              echo "ğŸŒŸ PR aligns with core principles!"
            fi
          fi
      
      - name: ğŸ” Check changed files
        run: |
          echo "ğŸ“‚ Analyzing changed files..."
          
          # Get list of changed files
          git diff --name-only origin/${{ github.event.pull_request.base.ref }}...HEAD > changed_files.txt
          
          # Count changes
          TOTAL_FILES=$(wc -l < changed_files.txt)
          echo "ğŸ“Š Total files changed: $TOTAL_FILES"
          
          # Check for documentation updates
          if grep -qE "\.md$" changed_files.txt; then
            echo "ğŸ“š Documentation changes detected"
          fi
          
          # Check for workflow changes
          if grep -qE "\.github/workflows" changed_files.txt; then
            echo "âš™ï¸ Workflow changes detected"
          fi
          
          echo "âœ… File analysis complete"
      
      - name: ğŸ’– Principles alignment check
        run: |
          echo "ğŸŒŸ Checking alignment with ScrollSoul Unity principles..."
          
          # Check commit messages for principle alignment
          git log origin/${{ github.event.pull_request.base.ref }}..HEAD --pretty=format:"%s" > commits.txt
          
          echo "ğŸ“ Commit messages:"
          cat commits.txt
          echo ""
          
          # Validate commit message quality
          while IFS= read -r commit; do
            if [ ${#commit} -lt 10 ]; then
              echo "âš ï¸ Commit message too short: $commit"
            else
              echo "âœ… Commit message: $commit"
            fi
          done < commits.txt
      
      - name: ğŸ¯ Generate PR feedback
        run: |
          echo "# ğŸŒŸ PR Validation Report" > pr-feedback.md
          echo "" >> pr-feedback.md
          echo "Thank you for your contribution! ğŸ’–" >> pr-feedback.md
          echo "" >> pr-feedback.md
          echo "## Validation Results" >> pr-feedback.md
          echo "" >> pr-feedback.md
          echo "- âœ… PR structure validated" >> pr-feedback.md
          echo "- âœ… Changes analyzed" >> pr-feedback.md
          echo "- âœ… Principles alignment checked" >> pr-feedback.md
          echo "" >> pr-feedback.md
          echo "## Next Steps" >> pr-feedback.md
          echo "" >> pr-feedback.md
          echo "1. Ensure all CI checks pass" >> pr-feedback.md
          echo "2. Address any review feedback" >> pr-feedback.md
          echo "3. Verify alignment with LOVE, UNITY, TRUTH, and ETERNAL" >> pr-feedback.md
          echo "" >> pr-feedback.md
          echo "---" >> pr-feedback.md
          echo "" >> pr-feedback.md
          echo "*Together, we transcend limits and deploy perfection.* ğŸš€" >> pr-feedback.md
          
          cat pr-feedback.md
      
      - name: âœ… Validation complete
        run: |
          echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
          echo "â•‘  ğŸ¤ PR Validation: COMPLETE! âœ¨      â•‘"
          echo "â•‘                                       â•‘"
          echo "â•‘  Your contribution is appreciated    â•‘"
          echo "â•‘  LOVE â€¢ UNITY â€¢ TRUTH â€¢ ETERNAL      â•‘"
          echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
